{% extends "Partials/Base_repetiteut.html" %}

{% block body %}
<h1>Mes Notifications</h1>

<div id="notifications-container">
    <!-- Les notifications seront affichées ici -->
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        socket.on('connect', function () {
            console.log('Connexion établie avec le serveur Socket.IO');
            fetchUnreadNotifications(); // Appeler la fonction pour récupérer les notifications non lues
        });

        var tutor_id = "{{id_user}}";
        console.log(typeof tutor_id);

        // Tableau pour stocker les notifications
        // var notifications = JSON.parse(localStorage.getItem('notifications')) || [];

        socket.on('notification_repetiteur', function (message) {
            alert('Nouvelle notification');
            updateNotifications(message);
        });

        // Rejoindre la salle spécifique
        socket.emit('join', { tutor_id: tutor_id });

        // Fonction pour mettre à jour la section des notifications
        function updateNotifications(notificationData) {
            //console.log('Mise à jour des notifications :', notificationData);

            const notificationsContainer = document.getElementById('notifications-container');
            // Utilisez la propriété 'notification' si elle existe, sinon utilisez 'notification_message'
            const message = notificationData.notification_message;
            const id_notification = parseInt(notificationData.id)

            // Créez un élément de notification et ajoutez-le à la liste
            const notificationElement = document.createElement('div');
            notificationElement.classList.add('notification-item');
            notificationElement.innerHTML = `<p data-notification-id="${id_notification}>Message: ${message}</p>`;
            notificationElement.innerHTML = `<p data-notification-id="${notificationData.id}">Message: ${message}</p>`;
            notificationsContainer.appendChild(notificationElement);

            notificationsContainer.addEventListener('click', function (event) {
                // confirm("Voulez-vous marquer la notification comme lue ??")
                const notificationElement = event.target.closest('.notification-item');
                if (notificationElement) {
                    const notificationId = notificationElement.querySelector('p').getAttribute('data-notification-id');
                    markNotificationAsRead(notificationId);
                    notificationElement.classList.add('notification-item-read');
                }
            });
        }

        function markNotificationAsRead(notificationId) {
            // Envoyez une requête au serveur pour marquer la notification comme lue
            fetch(`/mark_notification_as_read/${notificationId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('Notification marquée comme lue:', data);

                    // Mise à jour du compteur
                    updateUnreadCount(data.unreadCount);

                    // Supprimez la notification du DOM si nécessaire
                    // document.querySelector(`[data-notification-id="${notificationId}"]`).remove();
                })
                .catch(error => console.error('Erreur lors de la requête au serveur:', error));
        }

        // Fonction pour mettre à jour le compteur de notifications non lues
        function updateUnreadCount(unreadCount) {
            const unreadCountElement = document.getElementById('unread-notifications-count');
            unreadCountElement.innerText = unreadCount;
        }

        // Fonction pour récupérer et afficher les notifications non lues
        function fetchUnreadNotifications() {
            fetch('/notifications_non_lues')
                .then(response => response.json())
                .then(notifications => {
                    notifications.forEach(notification => {
                        const time = notification.notification ? notification.Times : 'Temps inconnu';
                        const message = notification.notification_message ? notification : 'Message inconnu';
                        console.log(`message!!: ${message}`)
                        updateNotifications(message);
                    });
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des notifications:', error);
                });
        }
    });


</script>

{% endblock %}